#include "m61mod.h"
#include "tracehash.h"

// aphash_primes[i] =
long aphash_primes[APHASH_PRIMES] = {
4099,4111,4127,4129,4133,4139,4153,4157,4159,4177,4201,4211,4217,4219,4229,4231,4241,4243,4253,4259,
4261,4271,4273,4283,4289,4297,4327,4337,4339,4349,4357,4363,4373,4391,4397,4409,4421,4423,4441,4447,
4451,4457,4463,4481,4483,4493,4507,4513,4517,4519,4523,4547,4549,4561,4567,4583,4591,4597,4603,4621,
4637,4639,4643,4649,4651,4657,4663,4673,4679,4691,4703,4721,4723,4729,4733,4751,4759,4783,4787,4789,
4793,4799,4801,4813,4817,4831,4861,4871,4877,4889,4903,4909,4919,4931,4933,4937,4943,4951,4957,4967,
4969,4973,4987,4993,4999,5003,5009,5011,5021,5023,5039,5051,5059,5077,5081,5087,5099,5101,5107,5113,
5119,5147,5153,5167,5171,5179,5189,5197,5209,5227,5231,5233,5237,5261,5273,5279,5281,5297,5303,5309,
5323,5333,5347,5351,5381,5387,5393,5399,5407,5413,5417,5419,5431,5437,5441,5443,5449,5471,5477,5479,
5483,5501,5503,5507,5519,5521,5527,5531,5557,5563,5569,5573,5581,5591,5623,5639,5641,5647,5651,5653,
5657,5659,5669,5683,5689,5693,5701,5711,5717,5737,5741,5743,5749,5779,5783,5791,5801,5807,5813,5821,
5827,5839,5843,5849,5851,5857,5861,5867,5869,5879,5881,5897,5903,5923,5927,5939,5953,5981,5987,6007,
6011,6029,6037,6043,6047,6053,6067,6073,6079,6089,6091,6101,6113,6121,6131,6133,6143,6151,6163,6173,
6197,6199,6203,6211,6217,6221,6229,6247,6257,6263,6269,6271,6277,6287,6299,6301,6311,6317,6323,6329,
6337,6343,6353,6359,6361,6367,6373,6379,6389,6397,6421,6427,6449,6451,6469,6473,6481,6491,6521,6529,
6547,6551,6553,6563,6569,6571,6577,6581,6599,6607,6619,6637,6653,6659,6661,6673,6679,6689,6691,6701,
6703,6709,6719,6733,6737,6761,6763,6779,6781,6791,6793,6803,6823,6827,6829,6833,6841,6857,6863,6869,
6871,6883,6899,6907,6911,6917,6947,6949,6959,6961,6967,6971,6977,6983,6991,6997,7001,7013,7019,7027,
7039,7043,7057,7069,7079,7103,7109,7121,7127,7129,7151,7159,7177,7187,7193,7207,7211,7213,7219,7229,
7237,7243,7247,7253,7283,7297,7307,7309,7321,7331,7333,7349,7351,7369,7393,7411,7417,7433,7451,7457,
7459,7477,7481,7487,7489,7499,7507,7517,7523,7529,7537,7541,7547,7549,7559,7561,7573,7577,7583,7589,
7591,7603,7607,7621,7639,7643,7649,7669,7673,7681,7687,7691,7699,7703,7717,7723,7727,7741,7753,7757,
7759,7789,7793,7817,7823,7829,7841,7853,7867,7873,7877,7879,7883,7901,7907,7919,7927,7933,7937,7949,
7951,7963,7993,8009,8011,8017,8039,8053,8059,8069,8081,8087,8089,8093,8101,8111,8117,8123,8147,8161,
8167,8171,8179,8191
};

// aphash_coeffs[i] = floor(pi*P^(i+1)) % P where P=2^61-1
long aphash_coeffs[APHASH_PRIMES] = {
326490430436040986L,559705121321738418L,1027143540648291608L,1614463795034667624L,455689193399227776L,
812966537786397194L,2073755909783565705L,1309198521558998535L,486216762465058766L,1847926951704044964L,
2093254198748441889L,566490051061970630L,150232564538834691L,1356728749119613735L,987635478950895264L,
1799657824218406718L,1921416341351658148L,1827423174086145070L,1750068052304413179L,1335382038239683171L,
1126485543032891129L,2189612557070775619L,1588425437950725921L,1906114970148501816L,1748768066189739575L,
1105553649419536683L,41823880976068680L,2246893936121305098L,680675478232219153L,1096492737570930588L,
1064058600983463886L,2124681778445686677L,1153253523204927664L,1624949962307564146L,884760591894578064L,
722684359584774534L,469294503455959899L,1078657853083538250L,497558833647780143L,430880240537243608L,
1008306263808672160L,871262219757043849L,1895004365215350114L,553114791335573273L,928282405904509326L,
1298199971472090520L,1361509731647030069L,426420832006230709L,750020119738494463L,892950654076632414L,
1225464410814600612L,1911848480297925904L,842847261377168671L,836690411740782547L,36595684701041066L,
57074465600036538L,35391454785304773L,1027606372000412697L,858149375821293895L,1216392374703443454L,
59308853655414224L,1030486962058546718L,382910609159726501L,768789926722341438L,762735381378628682L,
1005758989771948074L,1657009501638647508L,1783661361016004740L,796798233969021059L,1658520847567437422L,
502975179223457818L,2063998821801160708L,2126598223478603304L,817551008849328795L,1793074162393397615L,
1287596263315727892L,1629305847068896729L,2282065591485919335L,1280388906297308209L,173159035165825250L,
1203194438340773505L,2146825320332825798L,847076010454532974L,2132606604399767971L,865350797130078274L,
421223214903942949L,2202859852828864983L,1627572340776304831L,1301036100621122535L,2151172683210770621L,
555918022010940381L,1195820575245311406L,2060813966122583132L,824196499832939747L,1252314214858834971L,
380498114208176064L,621869463771460120L,1487674193901485781L,1569074147090699661L,1723498454689514459L,
1489838779667276265L,607626788325788389L,93543108859195056L,1874271115035734974L,1456016012787031897L,
619764822731213939L,1812449603590865741L,808484663842074461L,2009697952400734786L,1525933978789885248L,
343887624789001682L,1182376379945660137L,1982314473921546769L,1109549848371395693L,1037594154159590924L,
1071053104849367160L,1322181949714913233L,1516660949039528341L,960526604699918173L,1729904691101240134L,
261117919934717464L,2271784899875479358L,756802274277310875L,1289220444092802136L,474369139841197116L,
1716815258254385285L,103716246685267192L,543779117105835462L,1645057139707767457L,895800586311529398L,
1255427590538696616L,152478208398822237L,59235267842928844L,1502771737122401274L,1149578551939377903L,
1470772656511184950L,1546086255370076952L,1723497785943073942L,778240149963762596L,240870114509877266L,
394305328258085500L,2102620516550230799L,1039820873553197464L,979798654654721830L,880027557663442629L,
1676981816531131145L,1802107305139241263L,1972433293052973713L,2107405063590590043L,1798917982073452520L,
1369268024301602286L,867033797562981667L,1038357135783187942L,758476292223849603L,1948092882600628075L,
2207529277533454374L,1821419918118374849L,1231889908299259230L,566310110224392380L,1609356725483962542L,
280378617804444931L,1072662998681271815L,116308709127642766L,1193169610307430309L,866966243748392804L,
166237193327216135L,1077013023941018041L,404884253921467160L,786088301434511589L,1383535122407493085L,
2280658829488325172L,101154688442168806L,186007322364504054L,132651484623670765L,2214024743056683473L,
2082072212962344576L,1527055902872993253L,914904768868572390L,828477094595207304L,1020679050708770534L,
482636846586846145L,1930865547754160712L,1593671129282272719L,1493198467868909485L,729902645271416500L,
275540268357558312L,164114802119030362L,788447619988896953L,1762740703670330645L,660855577878083177L,
1651988416921493024L,740652833177384429L,1112201596451006206L,415698847934834932L,1211582319647132127L,
1146510220721650373L,1849436445614060470L,2087092872652683432L,2118502348483502728L,1356524772912098481L,
1199384942357517449L,172551026757446140L,578031956729941707L,523340081847222890L,1076777027268874489L,
504399020033657060L,1278551106709414382L,2159465951497451565L,1178157191616537256L,204263226455195995L,
1056341819781968292L,183521353142147658L,2188450004032853736L,815413180157425263L,1872285744226329343L,
959184959959358956L,473007083155872003L,655761716995053547L,1131460430873190185L,2139124645518872072L,
511733859594496686L,15198510254334311L,1224323599606986326L,717867206610437778L,2091512354759023324L,
372342232752868676L,1361511712413436237L,1389190973283340505L,394349220142131124L,2079377585202309849L,
353365880305796299L,2032166139485738617L,1890917131797951728L,242865361432353437L,1418792507475867019L,
2119099350463010017L,1014188227490285243L,479492624224518275L,1303029569429482669L,517247294593876834L,
1554557044656123283L,750281115903727536L,2167122262389919937L,760554688782332821L,2023636030598854916L,
1790146557619247357L,386163722563943194L,1515274606763521578L,2204179368292080266L,964158696771121369L,
303439105863023359L,8182230548124380L,1750434984088519049L,1725590414598766182L,1265114980378421064L,
1015227773830014864L,229929992560423398L,764214183816115409L,538352539450824188L,1941773060895353999L,
1068434172733967371L,1355790773646160387L,459324502245141234L,609129328626229402L,1241119177010491262L,
1783576433920437207L,1523680846139002895L,882824005398680507L,413096479776864968L,522865969927243974L,
1858351603281690756L,1968585526421383793L,2178118415854385403L,2071714574011626742L,2075065799199309684L,
2276241901353008033L,303400925906664587L,1426227202230524239L,1930606302598963877L,249953308414640146L,
611228839507773914L,1672745442514341102L,467604306000306674L,1474554813214382459L,1601661712875312382L,
614840167992924737L,1228071177654928913L,527816710270111610L,2217787042387174521L,639805394326521740L,
222549283662427192L,1360905187147121266L,2218130040969485290L,1295851844663939225L,563784543912533038L,
1995338666855533310L,1570565903061390324L,1421390998286027062L,1394318358097125191L,1259069656723159936L,
782274544912671248L,727119931274242152L,461373271832281770L,431218333850664873L,1192819027123234430L,
2078764559709872649L,185598300798682005L,753027393642717163L,39457098005678485L,1334017905593361063L,
2208208003949042369L,995759906937041788L,1045940157364976040L,194824647782216037L,550631184874398695L,
1360200364068800381L,1357865448826768161L,1831861326200370539L,942093021910086667L,1640270910790040055L,
186615109286328085L,1330440696074470319L,499018273810238035L,502274974614414055L,1207335215870481547L,
2013999866627689866L,1419916425046140717L,191559056573160841L,1328802988676857752L,1405960078185023606L,
227507798797399340L,1637526486952132401L,1076968863810265335L,944510191997220613L,1301386330701215932L,
285779824044017183L,1429750858521890899L,1618865668058420542L,841779507635076338L,2271885690336656780L,
1950830875641497149L,2020789551919109899L,975546679421148460L,1197104163269028491L,1270315990156796392L,
748604252817308486L,816129261753596233L,384118410847738091L,2113266006559319391L,1338854039375748358L,
1361143499198430117L,633423014922436774L,1290791779633361737L,81273616335831288L,734007502359373790L,
1803343551649794557L,178160046107106100L,1669700173018758407L,1829836142710185153L,1253431308749847288L,
70019619094993502L,939065521645602191L,571602252457140250L,26887212485499413L,984459396949257361L,
852773633209386873L,2289526104158020696L,756333221468239349L,478223842701987702L,2004947225028724200L,
526770890233938212L,1661268713623636486L,1595033927594418161L,1532663022957125952L,364955822302609296L,
603258635519191127L,371859597962583054L,94282227629658712L,2160611809915747887L,27000232625437140L,
22687777651226933L,734430233276692626L,1127699960534747774L,346857527391478939L,399588948728484631L,
1369575405845760568L,2217803687757289581L,2206814713288610370L,130141496340768529L,861110681132541840L,
230850531138610791L,1780590839341524422L,1923534983071749673L,1055631719355441015L,1222514615506258219L,
937915311769343786L,852868812961957254L,718656592041199719L,2250542267067365785L,2169537354592688250L,
1568074419444165342L,853778925104674827L,105031681250262217L,1204393036537417656L,592755100672600484L,
1509207668054427766L,1409630039748867615L,433329873945170157L,168130078420452894L,701434349299435396L,
1736119639406860361L,1801042332324036889L,82826810621030003L,581092394588713697L,1513323039712657034L,
2086339870071049553L,512802587457892537L,1294754943443095033L,1486581673100914879L,930909063370627411L,
2280060915913643774L,219424962331973086L,118156503193461485L,743557822870685069L,1997655344719642813L,
393161419260218815L,1086985962035808335L,2119375969747368461L,1650489163325525904L,1967094695603069467L,
916149623124228391L,1122737829960120900L,144869810337397940L,2261458899736343261L,1226838560319847571L,
897743852062682980L,45750188043851908L,1858576614171946931L,1568041120172266851L,289541060457747472L,
1539585379217609033L,866887122666596526L,6060188892447452L,1707684831658632807L,1062812350167057257L,
887626467969935688L,1968363468003847982L,2169897168216456361L,217716763626832970L,413611451367326769L,
336255814660537144L,1464084696245397914L,1902174501258288151L,1440415903059217441L,302153101507069755L,
1558366710940453537L,717776382684618355L,1206381076465295510L,1308718247292688437L,555835170043458452L,
1029518900794643490L,1034197980057311552L,131258234416495689L,260799345029896943L,
};

long aphash_list (long ap[APHASH_PRIMES])
{
    register long hash = 0;

    for ( register int i = 0 ; i < APHASH_PRIMES ; i++ )
        hash = m61add (hash, m61mul(m61mod_si(ap[i]),aphash_coeffs[i]));
    return hash;
}

long aphash (long (*ap)(long p, void *arg), void *arg)
{
    register long hash = 0;
    for ( register int i = 0 ; i < APHASH_PRIMES ; i++ )
        hash = m61add (hash, m61mul(m61mod_si((*ap)(aphash_primes[i], arg)),aphash_coeffs[i]));
    return hash;
}
